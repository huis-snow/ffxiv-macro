<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON 검증 도구</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        textarea { width: 100%; height: 300px; margin: 10px 0; }
        .error { color: red; background: #ffe6e6; padding: 10px; margin: 10px 0; }
        .success { color: green; background: #e6ffe6; padding: 10px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>JSON 파일 검증 도구</h1>
        
        <h3>1. 파일 업로드로 검증</h3>
        <input type="file" id="fileInput" accept=".json">
        <button onclick="validateFile()">파일 검증</button>
        
        <h3>2. 직접 붙여넣기로 검증</h3>
        <textarea id="jsonInput" placeholder="JSON 내용을 여기에 붙여넣으세요..."></textarea>
        <button onclick="validateText()">텍스트 검증</button>
        
        <h3>3. 수정된 JSON (오류 발견 시 자동 수정)</h3>
        <textarea id="fixedJson" placeholder="수정된 JSON이 여기에 표시됩니다..."></textarea>
        <button onclick="downloadFixed()">수정된 파일 다운로드</button>
        
        <div id="result"></div>
    </div>

    <script>
        function showResult(message, isError = false) {
            const result = document.getElementById('result');
            result.innerHTML = `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
        }

        function validateFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('파일을 선택하세요.', true);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                validateJson(content);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function validateText() {
            const content = document.getElementById('jsonInput').value;
            if (!content.trim()) {
                showResult('JSON 내용을 입력하세요.', true);
                return;
            }
            validateJson(content);
        }

        function validateJson(content) {
            try {
                // 기본 JSON 파싱 시도
                const data = JSON.parse(content);
                
                // 구조 검증
                if (typeof data !== 'object' || data === null) {
                    throw new Error('JSON은 객체여야 합니다.');
                }
                
                // macros와 missions 구조 확인
                if (!data.hasOwnProperty('macros')) {
                    data.macros = {};
                    showResult('⚠️ macros 속성이 없어서 추가했습니다.', false);
                }
                
                if (!data.hasOwnProperty('missions')) {
                    data.missions = {};
                    showResult('⚠️ missions 속성이 없어서 추가했습니다.', false);
                }
                
                // 매크로 데이터 검증
                let fixedCount = 0;
                for (const [key, macro] of Object.entries(data.macros)) {
                    if (typeof macro === 'string') {
                        // 레거시 형식 - 문제없음
                        continue;
                    } else if (typeof macro === 'object' && macro !== null) {
                        // 새 형식 - text 속성 확인
                        if (!macro.hasOwnProperty('text')) {
                            macro.text = macro.content || macro.macro || '';
                            fixedCount++;
                        }
                        if (!macro.hasOwnProperty('food')) {
                            macro.food = '';
                        }
                        if (!macro.hasOwnProperty('memo')) {
                            macro.memo = '';
                        }
                    } else {
                        // 잘못된 형식
                        data.macros[key] = {
                            text: String(macro),
                            food: '',
                            memo: ''
                        };
                        fixedCount++;
                    }
                }
                
                // 수정된 JSON 표시
                const fixedJson = JSON.stringify(data, null, 2);
                document.getElementById('fixedJson').value = fixedJson;
                
                let message = '✅ JSON이 유효합니다!';
                if (fixedCount > 0) {
                    message += ` (${fixedCount}개 항목이 자동 수정됨)`;
                }
                message += `<br>매크로 개수: ${Object.keys(data.macros).length}`;
                message += `<br>임무 개수: ${Object.keys(data.missions).length}`;
                
                showResult(message, false);
                
            } catch (error) {
                let errorMessage = `❌ JSON 오류: ${error.message}`;
                
                // 일반적인 JSON 오류 해결 방법 제시
                if (error.message.includes('Unexpected token')) {
                    errorMessage += '<br><br>💡 해결 방법:';
                    errorMessage += '<br>1. 따옴표가 제대로 닫혔는지 확인';
                    errorMessage += '<br>2. 마지막 항목 뒤에 쉼표(,)가 있는지 확인';
                    errorMessage += '<br>3. 중괄호 {}와 대괄호 []가 제대로 닫혔는지 확인';
                }
                
                if (error.message.includes('Unexpected end')) {
                    errorMessage += '<br><br>💡 파일이 잘리거나 불완전합니다.';
                }
                
                showResult(errorMessage, true);
            }
        }

        function downloadFixed() {
            const content = document.getElementById('fixedJson').value;
            if (!content.trim()) {
                showResult('수정된 JSON이 없습니다.', true);
                return;
            }
            
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'space_craft_macros_fixed.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showResult('✅ 수정된 파일이 다운로드되었습니다!', false);
        }
    </script>
</body>
</html>
