<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON ê²€ì¦ ë„êµ¬</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        textarea { width: 100%; height: 300px; margin: 10px 0; }
        .error { color: red; background: #ffe6e6; padding: 10px; margin: 10px 0; }
        .success { color: green; background: #e6ffe6; padding: 10px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>JSON íŒŒì¼ ê²€ì¦ ë„êµ¬</h1>
        
        <h3>1. íŒŒì¼ ì—…ë¡œë“œë¡œ ê²€ì¦</h3>
        <input type="file" id="fileInput" accept=".json">
        <button onclick="validateFile()">íŒŒì¼ ê²€ì¦</button>
        
        <h3>2. ì§ì ‘ ë¶™ì—¬ë„£ê¸°ë¡œ ê²€ì¦</h3>
        <textarea id="jsonInput" placeholder="JSON ë‚´ìš©ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
        <button onclick="validateText()">í…ìŠ¤íŠ¸ ê²€ì¦</button>
        
        <h3>3. ìˆ˜ì •ëœ JSON (ì˜¤ë¥˜ ë°œê²¬ ì‹œ ìë™ ìˆ˜ì •)</h3>
        <textarea id="fixedJson" placeholder="ìˆ˜ì •ëœ JSONì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
        <button onclick="downloadFixed()">ìˆ˜ì •ëœ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
        
        <div id="result"></div>
    </div>

    <script>
        function showResult(message, isError = false) {
            const result = document.getElementById('result');
            result.innerHTML = `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
        }

        function validateFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.', true);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                validateJson(content);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function validateText() {
            const content = document.getElementById('jsonInput').value;
            if (!content.trim()) {
                showResult('JSON ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.', true);
                return;
            }
            validateJson(content);
        }

        function validateJson(content) {
            try {
                // ê¸°ë³¸ JSON íŒŒì‹± ì‹œë„
                const data = JSON.parse(content);
                
                // êµ¬ì¡° ê²€ì¦
                if (typeof data !== 'object' || data === null) {
                    throw new Error('JSONì€ ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                }
                
                // macrosì™€ missions êµ¬ì¡° í™•ì¸
                if (!data.hasOwnProperty('macros')) {
                    data.macros = {};
                    showResult('âš ï¸ macros ì†ì„±ì´ ì—†ì–´ì„œ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.', false);
                }
                
                if (!data.hasOwnProperty('missions')) {
                    data.missions = {};
                    showResult('âš ï¸ missions ì†ì„±ì´ ì—†ì–´ì„œ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.', false);
                }
                
                // ë§¤í¬ë¡œ ë°ì´í„° ê²€ì¦
                let fixedCount = 0;
                for (const [key, macro] of Object.entries(data.macros)) {
                    if (typeof macro === 'string') {
                        // ë ˆê±°ì‹œ í˜•ì‹ - ë¬¸ì œì—†ìŒ
                        continue;
                    } else if (typeof macro === 'object' && macro !== null) {
                        // ìƒˆ í˜•ì‹ - text ì†ì„± í™•ì¸
                        if (!macro.hasOwnProperty('text')) {
                            macro.text = macro.content || macro.macro || '';
                            fixedCount++;
                        }
                        if (!macro.hasOwnProperty('food')) {
                            macro.food = '';
                        }
                        if (!macro.hasOwnProperty('memo')) {
                            macro.memo = '';
                        }
                    } else {
                        // ì˜ëª»ëœ í˜•ì‹
                        data.macros[key] = {
                            text: String(macro),
                            food: '',
                            memo: ''
                        };
                        fixedCount++;
                    }
                }
                
                // ìˆ˜ì •ëœ JSON í‘œì‹œ
                const fixedJson = JSON.stringify(data, null, 2);
                document.getElementById('fixedJson').value = fixedJson;
                
                let message = 'âœ… JSONì´ ìœ íš¨í•©ë‹ˆë‹¤!';
                if (fixedCount > 0) {
                    message += ` (${fixedCount}ê°œ í•­ëª©ì´ ìë™ ìˆ˜ì •ë¨)`;
                }
                message += `<br>ë§¤í¬ë¡œ ê°œìˆ˜: ${Object.keys(data.macros).length}`;
                message += `<br>ì„ë¬´ ê°œìˆ˜: ${Object.keys(data.missions).length}`;
                
                showResult(message, false);
                
            } catch (error) {
                let errorMessage = `âŒ JSON ì˜¤ë¥˜: ${error.message}`;
                
                // ì¼ë°˜ì ì¸ JSON ì˜¤ë¥˜ í•´ê²° ë°©ë²• ì œì‹œ
                if (error.message.includes('Unexpected token')) {
                    errorMessage += '<br><br>ğŸ’¡ í•´ê²° ë°©ë²•:';
                    errorMessage += '<br>1. ë”°ì˜´í‘œê°€ ì œëŒ€ë¡œ ë‹«í˜”ëŠ”ì§€ í™•ì¸';
                    errorMessage += '<br>2. ë§ˆì§€ë§‰ í•­ëª© ë’¤ì— ì‰¼í‘œ(,)ê°€ ìˆëŠ”ì§€ í™•ì¸';
                    errorMessage += '<br>3. ì¤‘ê´„í˜¸ {}ì™€ ëŒ€ê´„í˜¸ []ê°€ ì œëŒ€ë¡œ ë‹«í˜”ëŠ”ì§€ í™•ì¸';
                }
                
                if (error.message.includes('Unexpected end')) {
                    errorMessage += '<br><br>ğŸ’¡ íŒŒì¼ì´ ì˜ë¦¬ê±°ë‚˜ ë¶ˆì™„ì „í•©ë‹ˆë‹¤.';
                }
                
                showResult(errorMessage, true);
            }
        }

        function downloadFixed() {
            const content = document.getElementById('fixedJson').value;
            if (!content.trim()) {
                showResult('ìˆ˜ì •ëœ JSONì´ ì—†ìŠµë‹ˆë‹¤.', true);
                return;
            }
            
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'space_craft_macros_fixed.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showResult('âœ… ìˆ˜ì •ëœ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', false);
        }
    </script>
</body>
</html>
